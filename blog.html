<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>briankung.xyz - technical musings</title>
    <link rel="stylesheet" href="https://assets-cdn.github.com/assets/gist-embed-8c6ade0d3779da026346afb9bf324f67.css"></link>
  </head>
  <body>
    <!-- <article>
      <header></header>

      <section></section>

      <footer></footer>

    </article> -->
  </body>
</html>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script type="text/javascript">
  const GISTS_URL = 'https://api.github.com/users/briankung/gists'
  let gists, gistFileUrls, bodyContents
  bodyContents = []

  const debounce = (a,b=250,c) => (...d)=>clearTimeout(c,c=setTimeout(()=>a(...d),b))

  const fillBody = debounce((contents) => {
    contents.forEach(c => document.body.append(c))
  })

  async function main () {
    response = await fetch(GISTS_URL)
    gists = await response.json()
    gists = gists.filter(gist => /\brfc\b/i.test(gist.description))
    gistFileUrls = gists.map(
      (gist) => {
        return Object.entries(gist.files).map(([_, obj]) => obj.raw_url )
      }
    )

    await gistFileUrls.forEach(
      async (gistUrls) => {
        const results = await gistUrls.map(async (url) => {
          const response = await fetch(url)
          const text = await response.text()

          const gistId = url.match(/briankung\/(.+)\/raw/)[1]
          const fileName = url.split('/').pop()
          const section = document.createElement('section')

          if (url.endsWith('.md')) {
            section.innerHTML = marked(text)
            bodyContents.push(section)
          } else {
            const callbackName = `cb${gistId}${fileName.replace('.', '')}`
            const gistJsonpUrl = `https://gist.github.com/briankung/${gistId}.json?file=${fileName}&callback=${callbackName}`
            const script = document.createElement('script')
            const div = document.createElement('div')

            script.src = gistJsonpUrl
            div.id = `${gistId}${fileName}`

            bodyContents.push(div)

            window[callbackName] = function (gistData) {
              const i = bodyContents.indexOf(div)
              section.innerHTML = gistData.div
              bodyContents[i] = section
              fillBody(bodyContents)
            }

            document.body.appendChild(script)
          }

        })
      }
    )
  }

  main()
</script>

<style media="screen">
@media only screen and (min-width: 961px) {
  body {
    width: 50vw;
    margin: auto;
  }
}
</style>
